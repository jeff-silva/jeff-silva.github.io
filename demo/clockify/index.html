<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clockify</title>

  <!-- Axios -->
  <script src="https://unpkg.com/axios@1.2.0/dist/axios.min.js"></script>

  <!-- Vue -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://unpkg.com/vue-router@4.1.6/dist/vue-router.global.js"></script>

  <!-- Vuetify -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vuetify@3.0.3/dist/vuetify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/vuetify@3.0.3/dist/vuetify.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@6.9.96/css/materialdesignicons.min.css">

  <!-- Dayjs -->
  <script src="https://unpkg.com/dayjs@1.11.7/dayjs.min.js"></script>
  <script src="https://unpkg.com/dayjs@1.11.7/locale/en.js"></script>
  <script src="https://unpkg.com/dayjs@1.11.7/plugin/localeData.js"></script>
  <script>dayjs.locale('en'); dayjs.extend(dayjs_plugin_localeData);</script>

  <!-- Demo menu -->
  <script src="../demo-menu.js"></script>
</head>
<body>
  <div id="app">
    <v-app style="background:#f5f5f5;">
      <v-layout>
        <v-navigation-drawer
          :model-value="true"
          width="300"
        >
          <v-card-title>Clockify</v-card-title>
          <v-divider></v-divider>
          <v-card-text>
            Get your access token <a href="https://app.clockify.me/user/settings" target="_blank">here</a>.
            <v-text-field
              label="Access token"
              class="mt-3"
              type="password"
              v-model="storage.token"
            ></v-text-field>
          </v-card-text>
          <v-divider></v-divider>
          <v-card-text>
            <v-row>
              <v-col cols="12">
                <v-select
                  label="Workspace"
                  :model-value="$route.query.workspaceId || null"
                  :items="clockify.workspace.items"
                  item-value="id"
                  item-title="name"
                  :loading="clockify.workspace.loading"
                  @update:model-value="redirectQuery({ workspaceId: $event })"
                ></v-select>
              </v-col>
              <v-col cols="12">
                <v-card>
                  <app-calendar
                    :model-value="$route.query.date || dateDefault"
                    @update:model-value="redirectQuery({ date: $event })"
                  ></app-calendar>
                </v-card>
              </v-col>
              <v-col cols="12">
                <v-text-field
                  label="Ã€ receber"
                  v-model="clockify.userTimeEntries.total.amount"
                  :prefix="clockify.userTimeEntries.total.currency"
                  readonly
                ></v-text-field>
              </v-col>
            </v-row>
          </v-card-text>
        </v-navigation-drawer>

        <v-main style="height:100vh; overflow:auto;">
          <v-table fixed-header>
            <template #default>
              <colgroup>
                <col width="*">
                <col width="200px">
                <col width="150px">
              </colgroup>
              <thead>
                <tr>
                  <th>Task</th>
                  <th>Date</th>
                  <th>Time</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="3" class="pa-0" style="height:auto;">
                    <v-progress-linear
                      indeterminate
                      v-if="clockify.userTimeEntries.loading"
                    ></v-progress-linear>
                  </td>
                </tr>
                <tr v-if="!clockify.userTimeEntries.loading && clockify.userTimeEntries.items.length==0">
                  <td colspan="3">
                    <div class="text-center">No registers</div>
                  </td>
                </tr>
                <template v-for="(o, i) in clockify.userTimeEntries.items">
                  <tr v-bind="props">
                    <td>{{ o.description }}</td>
                    <td>
                      <pre v-if="o.timeInterval.start">{{ dateFormat(o.timeInterval.start) }}</pre>
                      <pre v-if="o.timeInterval.end">{{ dateFormat(o.timeInterval.end) }}</pre>
                    </td>
                    <td>
                      <template v-if="o.timeInterval.duration">
                        <pre>{{ o.timeInterval.duration.replace('PT', '').replace('H', 'h ').replace('M', 'm ').replace('S', 's') }}</pre>
                      </template>
                      <template v-else>
                        <pre>Em andamento</pre>
                      </template>
                    </td>
                  </tr>
                </template>
              </tbody>
            </template>
          </v-table>
          <demo-menu></demo-menu>
        </v-main>
      </v-layout>
    </v-app>
  </div>
  <script>
    let clockify = axios.create({
        baseURL: 'https://api.clockify.me/api/v1',
        headers: { 'X-Api-Key': 'MmM1MTVhZjMtM2ZhMS00YWVhLTk0MWYtZjNiY2Q3MDFiZmEw' },
        cache: {
          ttl: 1000 * 60 * 5,
          interpretHeader: false,
          methods: ['get'],
          cachePredicate: { statusCheck: (status) => status >= 200 && status < 400 },
          update: {},
          etag: false,
          modifiedSince: false,
          staleIfError: false
        },
    });
    Vue.createApp({
      watch: {
        $route: {deep:true, handler(value, old) {
          this.clockifyRouteChange(value, old);
        }},

        storage: {deep:true, handler(value) {
          localStorage.setItem('storage', JSON.stringify(value));
        }},
      },
      data() {
        return {
          dateDefault: dayjs().format('YYYY-MM-DD'),
          storage: (() => {
            let storage = {};
            try {
              storage = JSON.parse(localStorage.getItem('storage'));
            } catch(err) {}
            return {
              token: '',
              userId: false,
              ...storage
            };
          })(),
          clockify: {
            workspace: {
              loading: false,
              item: false,
              items: [],
            },
            userTimeEntries: {
              loading: false,
              total: {seconds:0, amount:0, currency:'BRL'},
              params: {
                start: '2022-11-30T00:00:00.000z',
                end: '2022-12-31T00:00:00.000z',
              },
              item: false,
              items: [],
            },
          },
        };
      },
      methods: {
        log: console.log,

        axiosInit() {
          axios.interceptors.request.use((config) => {
            if (config.url.startsWith('clockify://')) {
              config.url = config.url.replace('clockify:/', 'https://api.clockify.me/api/v1');
              config.headers['X-Api-Key'] = this.storage.token;
            }

            return config;
          });
        },

        debounce(id, time, callback) {
          window.debounces = window.debounces || {};
          if (window.debounces[id]) clearTimeout(window.debounces[id]);
          window.debounces[id] = setTimeout(callback, time);
        },

        dateFormat(date, format='DD/MM/YYYY - HH:mm') {
          return dayjs(date).format(format);
        },

        clockifyRouteChange(value, old) {
          const start = dayjs(value.query.date).format('YYYY-MM-01T00:00:00.000z');
          this.clockify.userTimeEntries.params.start = start;

          const end = dayjs(value.query.date).endOf('month').format('YYYY-MM-DDT23:59:59.000z');
          this.clockify.userTimeEntries.params.end = end;

          this.clockifyWorkspaceUserTimeEntries();
        },

        async clockifyUser() {
          if (!this.storage.userId) {
            const { data } = await axios.get('clockify://user');
            this.storage.userId = data.id;
          }
        },

        async clockifyWorkspaces() {
          this.clockify.workspace.loading = true;
          const { data } = await axios.get('clockify://workspaces');
          this.clockify.workspace.items = data;
          this.clockify.workspace.loading = false;
          if (data.length==1) {
            this.redirectQuery({ workspaceId: data[0].id });
            this.clockify.workspace.item = data[0];
          }
        },

        async clockifyWorkspaceUserTimeEntries() {
          this.clockify.userTimeEntries.loading = true;
          this.debounce('clockifyWorkspaceUserTimeEntries', 1000, async () => {
            const { workspaceId } = this.$route.query;
            if (!workspaceId) return;
  
            let userTimeEntriesTotal = {
              ...this.clockify.userTimeEntries.total,
              seconds: 0,
              amount: 0,
            };
  
            const { params } = this.clockify.userTimeEntries;
            try {
              const { data } = await axios.get(`clockify://workspaces/${workspaceId}/user/${this.storage.userId}/time-entries`, { params });
    
              this.clockify.userTimeEntries.items = data.map((item) => {
                item.timeInterval.durationData = {h:0, m:0, s:0};
                const regex = /PT((\d{0,2})H)*((\d{0,2})M)*((\d{0,2})S)*/gm;
                if (item.timeInterval.duration) {
                  const [,, h,, m,, s ] = [ ...item.timeInterval.duration.matchAll(regex) ][0];
                  let durationData = { h, m, s };
                  for(let i in durationData) { durationData[i] = parseInt(durationData[i] || 0); }
                  item.timeInterval.durationData = durationData;
                }
                return item;
              });
            } catch(err) {
              this.clockify.userTimeEntries.items = [];
            }
            this.clockify.userTimeEntries.loading = false;
  
            this.clockify.userTimeEntries.items.forEach((item) => {
              const seconds = item.timeInterval.durationData.s + (item.timeInterval.durationData.m*60) + (item.timeInterval.durationData.h*60*60);
              userTimeEntriesTotal.seconds += seconds;
            });
  
            const amount = (userTimeEntriesTotal.seconds / 60 / 60) * 13;
            if (amount>0) {
              const { data: currency } = await axios.get(`https://api.exchangerate.host/latest?base=AUD&amount=${amount}`);
              userTimeEntriesTotal.amount = currency.rates.BRL.toFixed(2);
            }
            
            this.clockify.userTimeEntries.total = userTimeEntriesTotal;
          });
        },

        redirectQuery(query={}) {
          query = { ...this.$route.query, ...query };
          this.$router.push({ ...this.$route, query });
        },
      },
      async mounted() {
        this.axiosInit();
        await this.clockifyUser();
        await this.clockifyWorkspaces();
      },
      components: {
        appCalendar: {
          props: {
            modelValue: {
              type: [Boolean, String],
              default: dayjs().format('YYYY-MM-DD'),
            },
          },
          computed: {
            month: {
              set(value) {},
              get() {
                const d = dayjs(this.modelValue);
                const r = {};
                r.year = d.format('YYYY');
                r.month = d.format('MM');
                r.monthName = d.format('MMMM');
                r.daysInMonth = d.daysInMonth();
                r.firstDay = d.startOf("month").day();
                r.weekdays = dayjs.weekdays().map(weekday => weekday.substring(0, 3));
                r.days = (() => {
                  const dayDefault = {id:null, day:null, dayName:null, dayAbbr:null};
                  let days=[];

                  for(let i=0; i<r.firstDay; i++) {
                    days.push({ ...dayDefault });
                  }
                  for(let i=1; i<=r.daysInMonth; i++) {
                    const dd = d.set('date', i);
                    let day = { ...dayDefault };
                    day.id = dd.format();
                    day.day = dd.date();
                    day.dayName = dayjs.weekdays()[ dd.day() ];
                    day.dayAbbr = day.dayName.substring(0, 3);
                    days.push(day);
                  }
                  
                  const chunk = (arr, size) => Array.from({ length: Math.ceil(arr.length / size) }, (v, i) => arr.slice(i * size, i * size + size));
                  return chunk(days, 7);
                })();
                return r;
              },
            },
          },
          methods: {
            monthAdd(n) {
              const month = dayjs(this.modelValue).add(n, 'month').format('YYYY-MM-DD');
              this.$emit('update:modelValue', month);
            },
          },
          template: `<div>
            <v-table>
              <template #default>
                <thead>
                  <tr>
                    <th colspan="2" class="p-0 text-left">
                      <v-btn flat :size="30" icon="mdi-chevron-left" @click="monthAdd(-1)"></v-btn>  
                    </th>
                    <th colspan="3" class="p-0 text-center">
                      {{ month.year }} {{ month.monthName }}
                    </th>
                    <th colspan="2" class="p-0 text-right">
                      <v-btn flat :size="30" icon="mdi-chevron-right" @click="monthAdd(1)"></v-btn>  
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <template v-for="wdays in month.days">
                    <tr>
                      <template v-for="d in wdays">
                        <td class="text-center pa-0">
                          <v-btn block flat :size="35">{{ d.day }}</v-btn>
                        </td>
                      </template>
                    </tr>
                  </template>
                </tbody>
              </template>  
            </v-table>
          </div>`,
        },
      },
    })
    .use(Vuetify.createVuetify({
      defaults: {
        VTextField: {variant: 'outlined', density: 'compact', hideDetails:true},
        VSelect: {variant: 'outlined', density: 'compact', hideDetails:true},
        VCombobox: {variant: 'outlined', density: 'compact', hideDetails:true},
      },
    }))
    .use(VueRouter.createRouter({
      history: VueRouter.createWebHashHistory(),
      routes: [],
    }))
    .use(createDemoMenu())
		.mount('#app');
  </script>
</body>
</html>